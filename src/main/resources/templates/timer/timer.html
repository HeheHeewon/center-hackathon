<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Timer</title>
    <script>
        var timerId, time;
        function formatTime(seconds) {
            var h = Math.floor(seconds / 3600);
            var m = Math.floor((seconds % 3600) / 60);
            var s = seconds % 60;
            return [h > 9 ? h : "0" + h, m > 9 ? m : "0" + m, s > 9 ? s : "0" + s].join(':');
        }

        document.addEventListener('DOMContentLoaded', function () {
            var initialTimeElement = document.getElementById('time');
            time = parseInt(initialTimeElement.textContent, 10);
            initialTimeElement.textContent = formatTime(time);

            if (!("Notification" in window)) {
                alert("This browser does not support desktop notifications.");
            } else if (Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("Notification permission granted.");
                        // Test notification
                        new Notification("Notification enabled", {body: "You will receive alerts!"});
                    } else {
                        console.log("Notification permission denied.");
                        document.getElementById('notificationMessage').textContent = "알림 권한 설정을 거부했습니다. 다시 설정하기 위해 브라우저 설정으로 이동해야 합니다.";
                    }
                });
            }
        });

        function showStretchingButton() {
            console.log("Showing stretching button");
            document.getElementById('notificationMessage').innerHTML =
                "알림 권한 설정을 거부했습니다. 타이머가 끝났습니다. <button onclick='location.href=\"http://localhost:8080/stretching\"'>스트레칭 페이지로 이동</button>";
        }

        function showNotification() {
            console.log("Attempting to show notification");
            if (Notification.permission === "granted") {
                var notification = new Notification("Timer Completed", {
                    body: "Time to do some eye exercises and stretching!",
                });
                notification.onclick = function (event) {
                    event.preventDefault();
                    console.log("Notification clicked, redirecting to http://localhost:8080/stretching");
                    window.location.href = 'http://localhost:8080/stretching';
                };
                console.log("Notification shown");
            } else {
                console.log("Notification permission not granted");
                showStretchingButton();
            }
        }

        function startTimer() {
            if (!timerId) {
                timerId = setInterval(function() {
                    if (time > 0) {
                        time--;
                        document.getElementById('time').textContent = formatTime(time);
                    } else {
                        document.getElementById('message').textContent = "Time's up!";
                        clearInterval(timerId);
                        timerId = null;
                        showNotification();
                    }
                }, 1000);
            }
        }

        function stopTimer() {
            clearInterval(timerId);
            timerId = null;
        }

    </script>
</head>
<body>
<h1>Timer</h1>
<form action="/timer" method="get">
    <select name="time">
        <option value="900">15 minutes</option>
        <option value="1800">30 minutes</option>
        <option value="2700">45 minutes</option>
        <option value="3600">1 hour</option>
    </select>
    <button type="submit">Set Timer</button>
</form>
<div id="time" th:text="${initialTime}"></div>
<div id="notificationMessage" style="color: red;"></div>
<div id="message"></div>
<button onclick="startTimer()">Start</button>
<button onclick="stopTimer()">Stop</button>
</body>
</html>
